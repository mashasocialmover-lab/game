html
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Cats vs Dogs: Boom Cat</title>
<style>
    body { 
        margin: 0; 
        overflow: hidden; 
        background-color: #5c4033; 
        background-image: 
            radial-gradient(circle at center, rgba(0,0,0,0) 20%, rgba(0,0,0,0.7) 100%),
            repeating-linear-gradient(
                0deg,
                transparent 0px,
                transparent 48px, 
                rgba(0,0,0,0.3) 49px,
                rgba(0,0,0,0.3) 50px
            );
        background-attachment: fixed;
        user-select: none;
        -webkit-user-select: none;
        touch-action: none;
        font-family: 'Segoe UI', sans-serif; 
    }
    canvas { display: block; }
    
    #instructions {
        position: absolute;
        top: 0; left: 0; width: 100%; text-align: center; color: #fff;
        font-size: 14px; text-shadow: 1px 1px 3px #000; z-index: 10;
        background: rgba(0, 0, 0, 0.7); padding: 10px 0;
        border-bottom: 1px solid #777;
        padding-right: 60px;
    }

    #costumeBtn {
        position: absolute;
        top: 10px; right: 10px;
        width: 60px; height: 60px;
        background: white; border-radius: 50%;
        font-size: 35px; text-align: center; line-height: 65px;
        cursor: pointer; z-index: 20;
        border: 3px solid #333;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        transition: transform 0.1s;
    }
    #costumeBtn:active { transform: scale(0.95); }

    #achievementBox {
        position: absolute; top: -150px; left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(to bottom, #FFD700, #FFA500);
        border: 4px solid #fff; border-radius: 15px;
        padding: 15px 30px; color: #8B4513;
        font-size: 24px; font-weight: bold;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 100; transition: top 0.5s ease-out;
        text-align: center; min-width: 250px;
    }
    .ach-icon { font-size: 30px; display: block; margin-bottom: 5px; }

    .legend-container {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 5px;
    }
    .legend { 
        font-weight: 600; cursor: pointer; padding: 4px 8px; border-radius: 4px; 
        transition: background 0.2s; border: 1px solid transparent;
        pointer-events: auto; 
    }
    .legend:hover { background: rgba(255,255,255,0.1); border-color: #777; }
    .legend:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }

    .c-dog { color: #d2691e; }
    .c-crazy { color: #d65db1; }
    .c-black { color: #ff4d4d; } /* –¶–≤–µ—Ç –±–æ–º–±—ã */
    .c-eater { color: #4dff88; }
    .c-player { color: #4db8ff; }
    .c-common { color: #ddd; }
    .c-mouse { color: #aaa; }
    
    .controls-info { color: #ffff00; font-size: 13px; margin-top: 5px; font-weight: bold; text-transform: uppercase;}

    .btn-group { margin-top: 8px; display: flex; justify-content: center; gap: 10px; }
    .btn {
        padding: 6px 12px; color: white; border-radius: 5px; font-weight: bold;
        cursor: pointer; pointer-events: auto; text-transform: uppercase; font-size: 12px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5); border: none;
    }
    .clear-btn { background-color: #e74c3c; }
    .clear-btn:hover { background-color: #ff5e57; }
    .pause-btn { background-color: #3498db; }
    .pause-btn:hover { background-color: #5dade2; }
    .pause-btn.paused { background-color: #f1c40f; color: black; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<div id="achievementBox">
    <span class="ach-icon">üèÜ</span>
    <span id="achText">–ú–û–õ–û–î–ï–¶!</span>
</div>

<div id="costumeBtn" onclick="changeCostume()" title="–ù–∞–¥–µ—Ç—å —à–∞–ø–∫—É!">üé©</div>

<div id="instructions">
    <div class="controls-info"><b>WASD</b> - –ë–µ–≥–∞—Ç—å | <b>Q</b> - –£–¥–∞—Ä | <b>E</b> - –î–µ–π—Å—Ç–≤–∏–µ | <b>C</b> - –ö–æ—Å—Ç—é–º</div>
    <div class="legend-container">
        <span class="legend c-mouse" onclick="spawnSpecific('MOUSE')" id="legend-mouse">üê≠ –ú–´–®–¨ (1 HP)</span>
        <span class="legend c-dog" onclick="spawnSpecific('DOG')" id="legend-dog">üê∂ –°–û–ë–ê–ö–ê (5 HP)</span>
        <span class="legend c-common" onclick="spawnSpecific('RUNNER')" id="legend-cat">üêà –ö–û–¢ (3 HP)</span>
        <span class="legend c-crazy" onclick="spawnSpecific('CRAZY')">ü§™ –ü–°–ò–• (4 HP)</span>
        <span class="legend c-black" onclick="spawnSpecific('BITER')">üí£ –ë–û–ú–ë–ê (0 HP)</span>
        <span class="legend c-eater" onclick="spawnSpecific('EATER')">ü§¢ –û–ë–ñ–û–†–ê (2 HP)</span>
        <span class="legend c-player" onclick="spawnSpecific('PLAYER')">üß∂ –ò–ì–†–£–ù (2 HP)</span>
    </div>
    <div class="btn-group">
        <button class="btn pause-btn" id="pauseBtn" onclick="togglePause()">‚è∏ –°–¢–û–ü</button>
        <button class="btn clear-btn" onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
</div>

<canvas id="canvas1"></canvas>

<script>
const canvas = document.getElementById('canvas1');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// –ì—Ä–∞–Ω–∏—Ü—ã –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
let gameArea = {
    left: 100,
    right: 0,
    top: 0,
    bottom: 0,
    width: 0,
    height: 0
};

function updateGameArea() {
    const instructionsHeight = document.getElementById('instructions').offsetHeight;
    gameArea.top = instructionsHeight + 50;
    gameArea.bottom = canvas.height - 50;
    gameArea.right = canvas.width - 100;
    gameArea.width = gameArea.right - gameArea.left;
    gameArea.height = gameArea.bottom - gameArea.top;
}
updateGameArea();

let particleArray = [];
let footprints = [];
let catsArray = []; 
let dogsArray = []; 
let miceArray = [];
let audioContext = null;
let mouse = { x: null, y: null, radius: 150 };
let aquarium = null;

const CAT_NAMES = ["–ë–∞—Ä—Å–∏–∫", "–ú—É—Ä–∑–∏–∫", "–†—ã–∂–∏–∫", "–ü—É—à–æ–∫", "–°–æ–Ω—è", "–ë–∞–≥–∏—Ä–∞", "–¢–∏–≥—Ä", "–°–Ω–µ–∂–æ–∫", "–§–µ–ª–∏–∫—Å", "–¢–æ–º", "–ë–æ—Ä–∏—Å", "–ö–µ–∫—Å", "–ë–ê–ë–ê–•"];
const DOG_NAMES = ["–†–µ–∫—Å", "–®–∞—Ä–∏–∫", "–ë–æ–±–∏–∫", "–ú—É—Ö—Ç–∞—Ä", "–ë–∞–ª—Ç–æ", "–î–∂–µ–∫", "–í–æ–ª—å—Ç", "–ü–æ–ª–∫–∞–Ω", "–î—Ä—É–∂–æ–∫", "–ë–∏–º"];
const MOUSE_NAMES = ["–î–∂–µ—Ä—Ä–∏", "–ü–∏–∫", "–ú–∏–∫–∫–∏", "–®—É—Å—Ç—Ä–∏–∫", "–ó–µ—Ä–Ω—ã—à–∫–æ", "–•–≤–æ—Å—Ç", "–°—Ç—é–∞—Ä—Ç", "–ö—Ä–æ—à"];

let gameStats = { miceCaught: 0, foodEaten: 0, swipes: 0, enemiesDefeated: 0 };

function getRandomName(type) {
    if (type === 'CAT') return CAT_NAMES[Math.floor(Math.random() * CAT_NAMES.length)];
    if (type === 'DOG') return DOG_NAMES[Math.floor(Math.random() * DOG_NAMES.length)];
    if (type === 'MOUSE') return MOUSE_NAMES[Math.floor(Math.random() * MOUSE_NAMES.length)];
    return "–ù–µ–∫—Ç–æ";
}

function showAchievement(text, icon = "üèÜ") {
    const box = document.getElementById('achievementBox');
    const txt = document.getElementById('achText');
    const ico = document.querySelector('.ach-icon');
    txt.innerText = text; ico.innerText = icon;
    box.style.top = "20px"; playSound('bounce');
    setTimeout(() => { box.style.top = "-150px"; }, 3000);
}

let isPaused = false;
let lastSpawnTime = 0; 
const COOLDOWN_MS = 1000; 
let lastClickTime = 0;
let lastClickId = null; 

const keys = { KeyW: false, KeyA: false, KeyS: false, KeyD: false, KeyE: false, KeyQ: false, KeyR: false, KeyC: false };
let playerEntity = null; 

window.addEventListener('keydown', e => {
    if (keys.hasOwnProperty(e.code)) keys[e.code] = true;
    if (e.code === 'KeyR') handleChangeSkin();
    if (e.code === 'KeyC') changeCostume(); 
});
window.addEventListener('keyup', e => { if (keys.hasOwnProperty(e.code)) keys[e.code] = false; });

window.togglePause = function() {
    isPaused = !isPaused;
    const btn = document.getElementById('pauseBtn');
    if (isPaused) { btn.innerHTML = "‚ñ∂ –ü–†–û–î–û–õ–ñ–ò–¢–¨"; btn.classList.add('paused'); } 
    else { btn.innerHTML = "‚è∏ –°–¢–û–ü"; btn.classList.remove('paused'); }
};

function handleChangeSkin() {
    let target = getTargetEntity();
    if (target) { target.changeAppearance(); playSound('bounce'); }
}

window.changeCostume = function() {
    let target = getTargetEntity();
    if (!target && catsArray.length > 0) {
        target = catsArray[Math.floor(Math.random() * catsArray.length)];
    }
    if (target && target instanceof Cat) {
        target.changeAccessory();
        playSound('bounce');
        let btn = document.getElementById('costumeBtn');
        btn.style.transform = "scale(0.8)";
        setTimeout(() => btn.style.transform = "scale(1)", 150);
        if(target.accessory === 'GLASSES') btn.innerText = 'üï∂Ô∏è';
        else if(target.accessory === 'TOPHAT') btn.innerText = 'üé©';
        else if(target.accessory === 'CROWN') btn.innerText = 'üëë';
        else if(target.accessory === 'BOW') btn.innerText = 'üéÄ';
        else btn.innerText = 'üò∫';
    }
};

function getTargetEntity() {
    if (playerEntity) return playerEntity;
    let allEntities = [...catsArray, ...dogsArray];
    for (let i = allEntities.length - 1; i >= 0; i--) {
        let entity = allEntities[i];
        let dist = Math.sqrt((entity.x - mouse.x)**2 + (entity.y - mouse.y)**2);
        if (dist < 50) return entity;
    }
    return null;
}

function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (audioContext.state === 'suspended') audioContext.resume(); }
function playSound(type) {
    if (!audioContext) return;
    const osc = audioContext.createOscillator(); const gainNode = audioContext.createGain();
    const now = audioContext.currentTime;
    if (type === 'bark') { osc.type = 'square'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(80, now + 0.1); gainNode.gain.setValueAtTime(0.2, now); }
    else if (type === 'swipe') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(100, now + 0.1); gainNode.gain.setValueAtTime(0.3, now); }
    else if (type === 'squeak') { osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now); gainNode.gain.setValueAtTime(0.1, now); }
    else if (type === 'hiss') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(800, now); gainNode.gain.setValueAtTime(0.1, now); }
    else if (type === 'whine') { osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); gainNode.gain.setValueAtTime(0.1, now); }
    else if (type === 'meow') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); gainNode.gain.setValueAtTime(0.1, now); }
    else if (type === 'eat') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); gainNode.gain.setValueAtTime(0.1, now); }
    else if (type === 'boom') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.5); gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5); }
    else { osc.type = 'square'; osc.frequency.setValueAtTime(150, now); gainNode.gain.setValueAtTime(0.05, now); }
    osc.connect(gainNode); gainNode.connect(audioContext.destination);
    osc.start(); osc.stop(now + 0.5);
}

window.clearAll = function() {
    catsArray = []; dogsArray = []; miceArray = []; footprints = []; playerEntity = null;
    particleArray.forEach(p => { p.eaten = false; p.size = (p.type === 'yarn') ? 5 : 3; p.respawnTimer = 0; });
};

window.spawnSpecific = function(type) {
    initAudio();
    updateGameArea();
    let x = gameArea.left + Math.random() * gameArea.width;
    let y = gameArea.top + Math.random() * gameArea.height;
    if (type === 'DOG') {
        let dog = new Dog(x, y);
        dogsArray.push(dog);
        updateLegendName('legend-dog', dog.name);
    }
    else if (type === 'MOUSE') {
        let mouse = new Mouse(x, y);
        miceArray.push(mouse);
        updateLegendName('legend-mouse', mouse.name);
    }
    else {
        let cat = new Cat(x, y, type);
        catsArray.push(cat);
        if (type === 'RUNNER') updateLegendName('legend-cat', cat.name);
    }
};

function updateLegendName(legendId, name) {
    const legend = document.getElementById(legendId);
    if (legend) {
        const text = legend.innerText;
        const parts = text.split(' ');
        if (parts.length > 0) {
            const emoji = parts[0];
            const hp = text.match(/\(.*\)/);
            legend.innerText = `${emoji} ${name} ${hp ? hp[0] : ''}`;
        }
    }
}

window.addEventListener('mousedown', e => { 
    if (e.target.id !== 'canvas1') return; 
    initAudio();
    updateGameArea();
    const currentTime = Date.now();
    const clickX = e.clientX; const clickY = e.clientY;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
    if (clickX < gameArea.left || clickX > gameArea.right || 
        clickY < gameArea.top || clickY > gameArea.bottom) {
        return;
    }
    
    let clickedObject = null;
    let allEntities = [...catsArray, ...dogsArray];
    for (let i = allEntities.length - 1; i >= 0; i--) {
        let entity = allEntities[i];
        let dist = Math.sqrt((entity.x - clickX)**2 + (entity.y - clickY)**2);
        if (dist < 45) { clickedObject = entity; break; }
    }
    if (clickedObject) {
        if (clickedObject.id === lastClickId && (currentTime - lastClickTime < 400)) {
            if (playerEntity) playerEntity.isPlayer = false;
            playerEntity = clickedObject; playerEntity.isPlayer = true; playerEntity.state = 'PLAYER_CONTROLLED';
            playSound('bounce'); lastClickId = null; return; 
        } else { lastClickId = clickedObject.id; lastClickTime = currentTime; return; }
    }
    if (currentTime - lastSpawnTime < COOLDOWN_MS) return;
    lastSpawnTime = currentTime;
    let rand = Math.random();
    if (rand < 0.03) {
        let dog = new Dog(clickX, clickY);
        dogsArray.push(dog);
        updateLegendName('legend-dog', dog.name);
    }
    else {
        let cat = new Cat(clickX, clickY);
        catsArray.push(cat);
        updateLegendName('legend-cat', cat.name);
    }
});

window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
window.addEventListener('resize', () => { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight; 
    updateGameArea();
    init(); 
});

function drawHpBar(ctx, hp, maxHp) {
    let w = 40; let h = 6; let y = -55;
    ctx.fillStyle = 'red'; ctx.fillRect(-w/2, y, w, h);
    ctx.fillStyle = '#00ff00';
    let hpW = (hp / maxHp) * w; if (hpW < 0) hpW = 0;
    ctx.fillRect(-w/2, y, hpW, h);
    ctx.strokeStyle = 'black'; ctx.lineWidth = 1; ctx.strokeRect(-w/2, y, w, h);
}

class Aquarium {
    constructor(x, y) {
        this.x = x; this.y = y; this.width = 140; this.height = 90;
        this.fishX = 20; this.fishY = 45; this.fishSpeed = 1; this.bubbles = [];
    }
    update() {
        this.fishX += this.fishSpeed;
        if (this.fishX > this.width - 20) this.fishSpeed = -1;
        if (this.fishX < 20) this.fishSpeed = 1;
        this.fishY = 45 + Math.sin(Date.now() * 0.005) * 10;
        if (Math.random() < 0.05) this.bubbles.push({x: Math.random() * this.width, y: this.height, speed: 0.5 + Math.random()});
        for (let i = this.bubbles.length - 1; i >= 0; i--) {
            let b = this.bubbles[i]; b.y -= b.speed;
            if (b.y < 0) this.bubbles.splice(i, 1);
        }
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y - this.height);
        ctx.fillStyle = 'rgba(0, 150, 255, 0.3)'; ctx.strokeStyle = '#aaa'; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.rect(0, 0, this.width, this.height); ctx.fill(); ctx.stroke();
        ctx.strokeStyle = 'green'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(20, this.height); ctx.quadraticCurveTo(25, this.height-20, 15, this.height-40);
        ctx.moveTo(100, this.height); ctx.quadraticCurveTo(95, this.height-25, 105, this.height-50); ctx.stroke();
        ctx.fillStyle = 'orange'; ctx.beginPath(); ctx.ellipse(this.fishX, this.fishY, 8, 5, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath();
        if (this.fishSpeed > 0) { ctx.moveTo(this.fishX - 8, this.fishY); ctx.lineTo(this.fishX - 12, this.fishY - 4); ctx.lineTo(this.fishX - 12, this.fishY + 4); } 
        else { ctx.moveTo(this.fishX + 8, this.fishY); ctx.lineTo(this.fishX + 12, this.fishY - 4); ctx.lineTo(this.fishX + 12, this.fishY + 4); }
        ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        this.bubbles.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 2, 0, Math.PI*2); ctx.fill(); });
        ctx.fillStyle = '#333'; ctx.fillRect(-5, -5, this.width + 10, 10);
        ctx.restore();
    }
}

class Mouse {
    constructor(x, y) {
        this.x = x; this.y = y; this.id = Math.random(); this.name = getRandomName('MOUSE');
        this.markedForDeletion = false; this.angle = Math.random() * Math.PI * 2; this.speed = 13; 
        this.vx = 0; this.vy = 0; this.state = 'WANDERING'; this.frame = 0;
        this.maxHp = 1; this.hp = 1;
        playSound('squeak');
    }
    update() {
        if (isPaused) return;
        this.frame++;
        if (this.frame % 10 === 0) footprints.push({x: this.x, y: this.y, angle: this.angle, life: 100, type: 'tiny'});
        let nearestCat = null; let minDist = 250;
        catsArray.forEach(cat => { let d = Math.sqrt((this.x - cat.x)**2 + (this.y - cat.y)**2); if (d < minDist) { minDist = d; nearestCat = cat; } });
        if (nearestCat) {
            this.state = 'FLEEING';
            let angleFromCat = Math.atan2(this.y - nearestCat.y, this.x - nearestCat.x);
            angleFromCat += (Math.random() - 0.5); 
            this.vx = Math.cos(angleFromCat) * this.speed; this.vy = Math.sin(angleFromCat) * this.speed;
        } else {
            this.state = 'WANDERING';
            if (this.frame % 10 === 0) {
                this.angle += (Math.random() - 0.5) * 1.5;
                this.vx = Math.cos(this.angle) * (this.speed * 0.6); this.vy = Math.sin(this.angle) * (this.speed * 0.6);
            }
        }
        this.x += this.vx; this.y += this.vy;
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
        if (this.x < gameArea.left + 20 || this.x > gameArea.right - 20) { this.vx *= -1; this.angle += Math.PI; }
        if (this.y < gameArea.top + 20 || this.y > gameArea.bottom - 20) { this.vy *= -1; this.angle += Math.PI; }
        this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
        this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
        this.angle = Math.atan2(this.vy, this.vx);
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y); 
        drawHpBar(ctx, this.hp, this.maxHp);
        ctx.fillStyle = '#fff'; ctx.font = '10px Arial'; ctx.textAlign = 'center'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2;
        ctx.strokeText(this.name, 0, -10); ctx.fillText(this.name, 0, -10);
        ctx.rotate(this.angle + Math.PI/2);
        ctx.beginPath(); ctx.moveTo(0, 5); ctx.quadraticCurveTo(Math.sin(this.frame*0.8)*5, 15, 0, 25);
        ctx.strokeStyle = 'pink'; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = '#aaa'; ctx.beginPath(); ctx.ellipse(0, 0, 6, 10, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'pink'; ctx.beginPath(); ctx.arc(-5, -5, 4, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(5, -5, 4, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }
}

class Dog {
    constructor(x, y) {
        this.x = x; this.y = y; this.id = Math.random(); this.name = getRandomName('DOG');
        this.markedForDeletion = false; this.isPlayer = false; this.actionCooldown = 0; this.frame = 0;
        this.angle = Math.random() * Math.PI * 2; this.speed = 7; 
        this.vx = Math.cos(this.angle) * this.speed; this.vy = Math.sin(this.angle) * this.speed;
        this.state = 'WANDERING'; this.barkTimer = 100 + Math.random() * 200;
        this.colors = ['#A0522D', '#222', '#DEB887', '#F5DEB3', '#8B4513']; this.skinColor = '#A0522D'; 
        this.maxHp = 5; this.hp = 5;
        playSound('bark');
    }
    changeAppearance() {
        let idx = this.colors.indexOf(this.skinColor);
        let nextIdx = (idx + 1) % this.colors.length;
        this.skinColor = this.colors[nextIdx];
    }
    update() {
        if (isPaused && !this.isPlayer) return;
        this.frame++;
        if ((this.vx !== 0 || this.vy !== 0) && this.frame % 15 === 0) {
            footprints.push({x: this.x, y: this.y, angle: this.angle, life: 150, type: 'paw'});
        }
        if (this.actionCooldown > 0) this.actionCooldown--;
        if (this.isPlayer) { this.handlePlayerInput(); return; }
        if (this.state === 'WANDERING') {
            this.barkTimer--;
            if (this.barkTimer <= 0) { this.doBark(); this.barkTimer = 150 + Math.random() * 300; }
            this.x += this.vx; this.y += this.vy;
            if (this.x < gameArea.left + 50 || this.x > gameArea.right - 50) this.vx *= -1;
            if (this.y < gameArea.top + 50 || this.y > gameArea.bottom - 50) this.vy *= -1;
            this.angle = Math.atan2(this.vy, this.vx);
        } else if (this.state === 'FLEEING') {
            this.x += this.vx; this.y += this.vy;
            if (this.x < gameArea.left - 100 || this.x > gameArea.right + 100 || this.y < gameArea.top - 100 || this.y > gameArea.bottom + 100) this.markedForDeletion = true;
        }
    }
    handlePlayerInput() {
        this.vx = 0; this.vy = 0; let moveSpeed = 5; 
        if (keys.KeyW) this.vy = -moveSpeed; if (keys.KeyS) this.vy = moveSpeed;
        if (keys.KeyA) this.vx = -moveSpeed; if (keys.KeyD) this.vx = moveSpeed;
        if (this.vx !== 0 && this.vy !== 0) { this.vx *= 0.71; this.vy *= 0.71; }
        this.x += this.vx; this.y += this.vy;
        if (this.vx !== 0 || this.vy !== 0) this.angle = Math.atan2(this.vy, this.vx);
        if (keys.KeyE && this.actionCooldown <= 0) { this.doBark(); this.actionCooldown = 60; }
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
        this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x)); 
        this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
    }
    doBark() {
        playSound('bark');
        catsArray.forEach(cat => {
            if (cat.state === 'WATCHING_FISH') return;
            let d = Math.sqrt((this.x - cat.x)**2 + (this.y - cat.y)**2);
            if (d < 60 && cat.actionCooldown <= 0 && cat.type !== 'BITER') {
                cat.hp--; cat.injuredTimer = 500; cat.actionCooldown = 60; 
                playSound('whine');
                if (cat.hp <= 0) { cat.markedForDeletion = true; playSound('whine'); }
            }
            if (d < 200 && cat.type !== 'CRAZY' && cat.type !== 'BITER') {
                cat.state = 'PANIC_RUN'; cat.angle = Math.atan2(cat.y - this.y, cat.x - this.x); 
                cat.vx = Math.cos(cat.angle) * 15; cat.vy = Math.sin(cat.angle) * 15;
            }
        });
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y);
        drawHpBar(ctx, this.hp, this.maxHp);
        if (!this.isPlayer) {
            ctx.fillStyle = '#fff'; ctx.font = '12px Arial'; ctx.textAlign = 'center'; ctx.strokeStyle = 'black'; ctx.lineWidth = 3;
            ctx.strokeText(this.name, 0, -35); ctx.fillText(this.name, 0, -35);
        }
        if (this.isPlayer) {
            ctx.beginPath(); ctx.ellipse(0, 5, 30, 15, 0, 0, Math.PI*2); ctx.strokeStyle = 'lime'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.font = "bold 12px Arial"; ctx.textAlign="center"; ctx.fillText("YOU", 0, -40);
        } else { ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(0, 5, 20, 10, 0, 0, Math.PI*2); ctx.fill(); }
        ctx.rotate(this.angle + Math.PI/2);
        let walkCycle = this.frame * 0.2; if ((this.isPlayer && this.vx === 0 && this.vy === 0) || (isPaused && !this.isPlayer)) walkCycle = 0; 
        let bodyStretch = Math.sin(walkCycle * 2) * 2;
        ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 10; ctx.lineCap = 'round';
        let l1 = Math.sin(walkCycle)*12, l2 = Math.sin(walkCycle+Math.PI)*12;
        ctx.beginPath(); ctx.moveTo(-12, 0); ctx.lineTo(-12, -15 + l1); ctx.stroke(); ctx.beginPath(); ctx.moveTo(12, 0); ctx.lineTo(12, -15 + l2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-12, 20); ctx.lineTo(-12, 35 + l2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(12, 20); ctx.lineTo(12, 35 + l1); ctx.stroke();
        let tailWag = Math.sin(this.frame * 0.5) * 15;
        ctx.beginPath(); ctx.lineWidth = 8; ctx.moveTo(0, 35); ctx.lineTo(tailWag, 55); ctx.stroke();
        ctx.fillStyle = this.skinColor; 
        ctx.beginPath(); ctx.ellipse(0, 10, 18 - bodyStretch, 30 + bodyStretch, 0, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'blue'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(-14, -10); ctx.quadraticCurveTo(0, -8, 14, -10); ctx.stroke();
        ctx.fillStyle = this.skinColor; ctx.beginPath(); ctx.arc(0, -15, 20, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = adjustColor(this.skinColor, -40); 
        ctx.beginPath(); ctx.ellipse(-18, -10, 8, 15, 0.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(18, -10, 8, 15, -0.5, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(-8, -20, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-8, -20, 2, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(8, -20, 2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.ellipse(0, -8, 5, 3, 0, 0, Math.PI*2); ctx.fill();
        if (this.state === 'FLEEING') { ctx.rotate(-(this.angle + Math.PI/2)); ctx.fillStyle = 'white'; ctx.font = "bold 20px Arial"; ctx.fillText("?!", 0, -50); }
        ctx.restore();
    }
}

// === –ö–õ–ê–°–° –ö–û–¢–ê ===
class Cat {
    constructor(x, y, forcedType = null) {
        this.x = x; this.y = y;
        this.id = Math.random();
        this.name = (forcedType === 'BITER') ? '–ë–ê–ë–ê–•' : getRandomName('CAT');
        this.markedForDeletion = false;
        this.isPlayer = false;
        this.actionCooldown = 0;
        this.swipeAnimTimer = 0;
        this.injuredTimer = 0;
        this.accessory = 'NONE'; 
        this.accessoryList = ['NONE', 'GLASSES', 'TOPHAT', 'CROWN', 'BOW'];
        this.fishWatchTimer = 0;
        this.frame = 0;
        this.blinkTimer = Math.random() * 200;
        this.isBlinking = false;
        this.availableSkins = ['orange', 'white', 'grey', 'siamese', 'calico', 'tuxedo', 'tabby', 'black'];

        if (forcedType) {
            this.type = forcedType;
        } else {
            let rand = Math.random();
            if (rand < 0.05) this.type = 'CRAZY';
            else if (rand < 0.15) this.type = 'EATER';
            else if (rand < 0.25) this.type = 'PLAYER';
            else if (rand < 0.35) this.type = 'BITER';
            else this.type = 'RUNNER';
        }

        if (this.type === 'CRAZY' || this.type === 'BITER') {
            this.skin = 'black';
        } else {
            let safeSkins = this.availableSkins.filter(s => s !== 'black');
            this.skin = safeSkins[Math.floor(Math.random() * safeSkins.length)];
        }

        // !!! –£–°–¢–ê–ù–û–í–ö–ê –•–ü –° –ü–°–ò–•–û–ú –ò –ë–û–ú–ë–û–ô
        if (this.type === 'CRAZY') { this.maxHp = 4; this.hp = 4; } 
        else if (this.type === 'PLAYER' || this.type === 'EATER') { this.maxHp = 2; this.hp = 2; }
        else if (this.type === 'BITER') { this.maxHp = 0; this.hp = 0; } // –£ –±–æ–º–±—ã –Ω–µ—Ç —Ö–ø
        else { this.maxHp = 3; this.hp = 3; }

        this.setStatsByType();
        this.colors = this.getSkinColors();
    }

    changeAccessory() {
        let idx = this.accessoryList.indexOf(this.accessory);
        let nextIdx = (idx + 1) % this.accessoryList.length;
        this.accessory = this.accessoryList[nextIdx];
    }

    setStatsByType() {
        if (this.type === 'CRAZY') { this.speed = 18; this.bounceCount = 0; this.maxBounces = 5; this.chasingDog = null; playSound('meow'); } 
        else if (this.type === 'EATER') { this.foodConsumed = 0; this.maxFood = 6; this.targetItem = null; this.speed = 5; this.state = 'HUNTING'; }
        else if (this.type === 'PLAYER') { this.targetItem = null; this.playTimer = 180; this.speed = 9; this.state = 'SEARCHING'; }
        else if (this.type === 'BITER') { this.timer = 100; this.isActing = false; this.actionRadius = 0; this.maxActionRadius = 350; this.soundPlayed = false; this.speed = 6; }
        else { this.speed = 12 + Math.random() * 5; if(Math.random()>0.6) playSound('meow'); }
        if (this.type === 'BITER') this.angle = -Math.PI/2; else this.angle = Math.random() * Math.PI * 2;
        this.vx = Math.cos(this.angle)*this.speed; this.vy = Math.sin(this.angle)*this.speed;
    }

    changeAppearance() {
        let idx = this.availableSkins.indexOf(this.skin);
        let nextIdx = (idx + 1) % this.availableSkins.length;
        this.skin = this.availableSkins[nextIdx];
        this.colors = this.getSkinColors();
    }

    getSkinColors() {
        switch(this.skin) {
            case 'orange': return { b1: '#ffb347', b2: '#ffcc33', d: '#cc8400', e: '#90ee90' };
            case 'white': return { b1: '#f0f0f0', b2: '#ffffff', d: '#ddd', e: '#87ceeb' };
            case 'black': return { b1: '#2b2b2b', b2: '#404040', d: '#111', e: '#ffff00' };
            case 'grey': return { b1: '#a9a9a9', b2: '#c0c0c0', d: '#808080', e: '#98fb98' };
            case 'siamese': return { b1: '#fff5e1', b2: '#fffaf0', d: '#5c4a3d', e: '#00bfff' };
            case 'calico': return { b1: '#ffffff', b2: '#fff', d: 'calico', e: '#ffa500' };
            case 'tuxedo': return { b1: '#222', b2: '#333', d: 'tuxedo', e: '#adff2f' };
            case 'tabby': return { b1: '#b8a488', b2: '#d2b48c', d: 'tabby', e: '#32cd32' };
            default: return { b1: '#fff', b2: '#fff', d: '#ccc', e: 'blue' };
        }
    }

    findNearestItem(type) {
        let closest = null, minDist = Infinity;
        for (let p of particleArray) {
            if (p.type === type && !p.eaten) {
                let d = (p.x - this.x)**2 + (p.y - this.y)**2;
                if (d < minDist) { minDist = d; closest = p; }
            }
        }
        return closest;
    }

    update() {
        if (isPaused && !this.isPlayer) return;
        this.frame++;
        if (this.swipeAnimTimer > 0) this.swipeAnimTimer--;
        if (this.injuredTimer > 0) this.injuredTimer--; 
        if ((this.vx !== 0 || this.vy !== 0) && this.frame % 15 === 0) {
            footprints.push({x: this.x, y: this.y, angle: this.angle, life: 150, type: 'paw'});
        }
        this.blinkTimer--;
        if (this.blinkTimer <= 0) { this.isBlinking = true; if (this.blinkTimer <= -10) { this.isBlinking = false; this.blinkTimer = 100 + Math.random() * 300; } }
        if (this.actionCooldown > 0) this.actionCooldown--;
        if (this.isPlayer) {
            this.handlePlayerInput();
            if (this.type === 'BITER' && this.isActing) {
                this.actionRadius += 20;
                if (this.actionRadius >= this.maxActionRadius) { this.markedForDeletion = true; playerEntity = null; }
            }
            return;
        }
        if (this.state === 'WATCHING_FISH') {
            this.fishWatchTimer--;
            this.vx = 0; this.vy = 0; 
            this.angle = Math.atan2(aquarium.y - (aquarium.height/2) - this.y, aquarium.x + (aquarium.width/2) - this.x);
            if (this.fishWatchTimer <= 0) { this.state = 'WANDERING'; this.angle += Math.PI; }
            return; 
        }
        if (aquarium && ['RUNNER', 'EATER', 'PLAYER'].includes(this.type) && this.state !== 'PANIC_RUN') {
            let distToTank = Math.sqrt((this.x - (aquarium.x + 70))**2 + (this.y - (aquarium.y - 20))**2);
            if (distToTank < 100 && Math.random() < 0.02) { this.state = 'WATCHING_FISH'; this.fishWatchTimer = 300 + Math.random() * 300; }
        }
        let nearestDog = null; let minDogDist = 200; 
        for(let dog of dogsArray) {
            let d = Math.sqrt((this.x - dog.x)**2 + (this.y - dog.y)**2);
            if (d < minDogDist) { minDogDist = d; nearestDog = dog; }
        }
        if (nearestDog) {
            if (this.type === 'CRAZY') {
                this.chasingDog = nearestDog;
                let angleToDog = Math.atan2(nearestDog.y - this.y, nearestDog.x - this.x);
                this.vx = Math.cos(angleToDog) * 20; this.vy = Math.sin(angleToDog) * 20;
                this.x += this.vx; this.y += this.vy;
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
                this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
                this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
                if (minDogDist < 40) {
                    playSound('hiss'); playSound('whine'); 
                    nearestDog.state = 'FLEEING'; nearestDog.angle = angleToDog; 
                    nearestDog.vx = Math.cos(angleToDog) * 15; nearestDog.vy = Math.sin(angleToDog) * 15;
                }
            } else if (this.type !== 'BITER') {
                if (this.state !== 'PANIC_RUN') {
                    this.state = 'PANIC_RUN';
                    let angleFromDog = Math.atan2(this.y - nearestDog.y, this.x - nearestDog.x);
                    let randomScattering = (Math.random() - 0.5) * 2.5; 
                    this.angle = angleFromDog + randomScattering;
                    let panicSpeed = (this.speed < 15) ? 15 : this.speed + 2;
                    this.vx = Math.cos(this.angle) * panicSpeed; this.vy = Math.sin(this.angle) * panicSpeed;
                }
                this.x += this.vx; this.y += this.vy;
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
                this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
                this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
                if (this.isOffScreen()) this.markedForDeletion = true;
                return; 
            }
        } else { if (this.state === 'PANIC_RUN') this.state = 'WANDERING'; }

        if (this.type === 'EATER') {
            if (this.state === 'HUNTING') {
                if (!this.targetItem || this.targetItem.eaten) this.targetItem = this.findNearestItem('food');
                if (this.targetItem) {
                    let dx = this.targetItem.x - this.x, dy = this.targetItem.y - this.y;
                    let d = Math.sqrt(dx*dx + dy*dy);
                    this.angle = Math.atan2(dy, dx);
                    if (d > 10) { 
                        this.x += Math.cos(this.angle)*this.speed; 
                        this.y += Math.sin(this.angle)*this.speed;
                        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
                        this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
                        this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
                    }
                    else {
                        playSound('eat'); this.targetItem.eaten = true; this.targetItem.size = 0; this.targetItem.respawnTimer = 300; 
                        this.foodConsumed++; 
                        if (this.isPlayer) { gameStats.foodEaten++; if (gameStats.foodEaten % 10 === 0) showAchievement("üçñ –í–ï–õ–ò–ö–ò–ô –û–ë–ñ–û–†–ê!", "üçñ"); }
                        this.targetItem = null;
                        if (this.foodConsumed >= this.maxFood) { this.state = 'LEAVING'; this.angle = Math.random()*Math.PI*2; }
                    }
                } else { this.state = 'LEAVING'; this.angle = Math.random()*Math.PI*2; }
            } else if (this.state === 'LEAVING') {
                this.x += Math.cos(this.angle)*this.speed*1.5; 
                this.y += Math.sin(this.angle)*this.speed*1.5;
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
                this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
                this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
                if (this.isOffScreen()) this.markedForDeletion = true;
            }
        }
        else if (this.type === 'PLAYER') {
            if (this.state === 'SEARCHING') {
                if (!this.targetItem) this.targetItem = this.findNearestItem('yarn');
                if (this.targetItem) {
                    let dx = this.targetItem.x - this.x, dy = this.targetItem.y - this.y;
                    let d = Math.sqrt(dx*dx+dy*dy);
                    this.angle = Math.atan2(dy, dx);
                    if (d > 40) { 
                        this.x += Math.cos(this.angle)*this.speed; 
                        this.y += Math.sin(this.angle)*this.speed;
                        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
                        this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
                        this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
                    }
                    else this.state = 'PLAYING';
                } else { this.state = 'LEAVING'; this.angle = Math.random()*Math.PI*2; }
            } else if (this.state === 'PLAYING') {
                this.playTimer--;
                if (this.targetItem) {
                    this.angle = Math.atan2(this.targetItem.y - this.y, this.targetItem.x - this.x);
                    if (this.frame % 20 === 0) {
                         let push = this.angle + (Math.random()-0.5);
                         this.targetItem.vx += Math.cos(push)*4; this.targetItem.vy += Math.sin(push)*4;
                    }
                }
                if (this.playTimer <= 0) { this.state = 'LEAVING'; this.angle = Math.random()*Math.PI*2; }
            } else if (this.state === 'LEAVING') {
                this.x += Math.cos(this.angle)*this.speed; 
                this.y += Math.sin(this.angle)*this.speed;
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
                this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
                this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
                if (this.isOffScreen()) this.markedForDeletion = true;
            }
        }
        else if (this.type === 'BITER') {
            if (this.isActing) {
                // –í–ó–†–´–í –õ–û–ì–ò–ö–ê
                this.actionRadius += 20;
                if (this.actionRadius >= this.maxActionRadius) { this.markedForDeletion = true; }
                // –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
                [...dogsArray, ...miceArray].forEach(target => {
                    let d = Math.sqrt((this.x - target.x)**2 + (this.y - target.y)**2);
                    if (d < this.actionRadius) {
                        target.hp = 0; // Kill
                        target.markedForDeletion = true;
                    }
                });
            } else {
                if (this.timer > 0) this.timer--;
                else {
                    this.isActing = true; playSound('boom'); 
                }
            }
        }
        else { 
            this.x += this.vx; this.y += this.vy;
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
            this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
            this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
            
            if (this.type === 'CRAZY' && this.bounceCount < this.maxBounces && !this.chasingDog) {
                let hit = false;
                if (this.x <= gameArea.left + 30 || this.x >= gameArea.right - 30) { this.vx *= -1; hit=true; this.angle = Math.atan2(this.vy, this.vx); }
                if (this.y <= gameArea.top + 30 || this.y >= gameArea.bottom - 30) { this.vy *= -1; hit=true; this.angle = Math.atan2(this.vy, this.vx); }
                if (hit) { this.bounceCount++; playSound('bounce'); }
            } else if (!this.chasingDog) {
                this.angle = Math.atan2(this.vy, this.vx);
            }
            if (this.isOffScreen()) {
                if (this.type !== 'CRAZY' || this.bounceCount >= this.maxBounces) this.markedForDeletion = true;
            }
        }
    }

    handlePlayerInput() {
        if (this.type === 'BITER' && this.isActing) return;
        this.vx = 0; this.vy = 0; let moveSpeed = 5; if (this.type === 'CRAZY') moveSpeed = 8;
        if (keys.KeyW) this.vy = -moveSpeed; if (keys.KeyS) this.vy = moveSpeed;
        if (keys.KeyA) this.vx = -moveSpeed; if (keys.KeyD) this.vx = moveSpeed;
        if (this.vx !== 0 && this.vy !== 0) { this.vx *= 0.71; this.vy *= 0.71; }
        this.x += this.vx; this.y += this.vy;
        if (this.vx !== 0 || this.vy !== 0) this.angle = Math.atan2(this.vy, this.vx);
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
        this.x = Math.max(gameArea.left + 20, Math.min(gameArea.right - 20, this.x));
        this.y = Math.max(gameArea.top + 20, Math.min(gameArea.bottom - 20, this.y));
        if (keys.KeyE && this.actionCooldown <= 0) { this.doPlayerAction(); }
        if (keys.KeyQ && this.actionCooldown <= 0) {
            this.doSwipeAttack(); gameStats.swipes++;
            if (gameStats.swipes === 5 || gameStats.swipes === 20) showAchievement("ü•ä –ë–û–ï–¶!", "ü•ä");
            this.actionCooldown = 20; 
        }
    }
    
    doSwipeAttack() {
        playSound('swipe'); this.swipeAnimTimer = 10; 
        miceArray.forEach(mouse => {
            let d = Math.sqrt((this.x - mouse.x)**2 + (this.y - mouse.y)**2);
            if (d < 80) { 
                mouse.hp--; playSound('squeak'); 
                if (mouse.hp <= 0) { mouse.markedForDeletion = true; gameStats.miceCaught++; if (gameStats.miceCaught === 5) showAchievement("üê≠ –ì–†–û–ó–ê –ú–´–®–ï–ô!", "üòº"); }
            }
        });
        dogsArray.forEach(dog => {
            let d = Math.sqrt((this.x - dog.x)**2 + (this.y - dog.y)**2);
            if (d < 80) { 
                dog.hp--; playSound('whine'); 
                if (dog.hp <= 0) { dog.markedForDeletion = true; gameStats.enemiesDefeated++; showAchievement("–í–†–ê–ì –ü–û–í–ï–†–ñ–ï–ù!", "üíÄ"); }
            }
        });
    }

    doPlayerAction() {
        this.actionCooldown = 30; 
        if (this.type === 'BITER') { this.timer = 0; this.isActing = true; this.actionCooldown = 9999; playSound('boom'); }
        else if (this.type === 'EATER') {
            let item = this.findNearestItem('food');
            if (item && Math.sqrt((this.x-item.x)**2 + (this.y-item.y)**2) < 30) {
                playSound('eat'); item.eaten = true; item.size = 0; item.respawnTimer = 300; this.foodConsumed++;
                if (this.isPlayer) { gameStats.foodEaten++; if (gameStats.foodEaten % 10 === 0) showAchievement("üçñ –í–ï–õ–ò–ö–ò–ô –û–ë–ñ–û–†–ê!", "üçñ"); }
            }
        }
        else if (this.type === 'PLAYER') {
            let item = this.findNearestItem('yarn');
            if (item && Math.sqrt((this.x-item.x)**2 + (this.y-item.y)**2) < 50) {
                let push = this.angle; item.vx += Math.cos(push)*15; item.vy += Math.sin(push)*15;
                this.state = 'PLAYING'; setTimeout(() => this.state = 'SEARCHING', 300);
            }
        }
        else if (this.type === 'CRAZY') {
            playSound('hiss');
            dogsArray.forEach(dog => {
                let d = Math.sqrt((this.x - dog.x)**2 + (this.y - dog.y)**2);
                if (d < 200) { playSound('whine'); dog.state = 'FLEEING'; dog.angle = Math.atan2(dog.y - this.y, dog.x - this.x); dog.vx = Math.cos(dog.angle)*15; dog.vy = Math.sin(dog.angle)*15; }
            });
        } else { playSound('meow'); }
    }

    isOffScreen() { return (this.x < gameArea.left - 100 || this.x > gameArea.right + 100 || this.y < gameArea.top - 100 || this.y > gameArea.bottom + 100); }

    draw() {
        // –†–ò–°–£–ï–ú –í–ó–†–´–í –ë–û–ú–ë–´
        if (this.type === 'BITER' && this.isActing) {
            ctx.beginPath(); ctx.arc(this.x, this.y, this.actionRadius, 0, Math.PI*2);
            let a = 1 - (this.actionRadius/this.maxActionRadius);
            let grd = ctx.createRadialGradient(this.x, this.y, this.actionRadius*0.5, this.x, this.y, this.actionRadius);
            grd.addColorStop(0, `rgba(255, 255, 200, ${a})`); grd.addColorStop(1, `rgba(255, 50, 0, 0)`);
            ctx.fillStyle = grd; ctx.fill();
            ctx.font = "900 40px Impact"; ctx.fillStyle = `rgba(255, 255, 255, ${a})`; ctx.strokeStyle = `rgba(0,0,0,${a})`; ctx.lineWidth = 4;
            ctx.textAlign = "center"; ctx.strokeText("–ë–ê–ë–ê–•!", this.x, this.y); ctx.fillText("–ë–ê–ë–ê–•!", this.x, this.y);
            return; 
        }

        ctx.save(); ctx.translate(this.x, this.y);
        
        // –†–ò–°–£–ï–ú –•–ü –ï–°–õ–ò –≠–¢–û –ù–ï –ë–û–ú–ë–ê
        if (this.type !== 'BITER') drawHpBar(ctx, this.hp, this.maxHp);

        if (!this.isPlayer) {
            ctx.fillStyle = '#fff'; ctx.font = '12px Arial'; ctx.textAlign = 'center'; ctx.strokeStyle = 'black'; ctx.lineWidth = 3;
            ctx.strokeText(this.name, 0, -35); ctx.fillText(this.name, 0, -35);
        }
        if (this.isPlayer) {
            ctx.beginPath(); ctx.ellipse(0, 5, 25, 15, 0, 0, Math.PI*2); ctx.strokeStyle = 'lime'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.font = "bold 12px Arial"; ctx.textAlign="center"; ctx.fillText("YOU", 0, -40);
        } else { ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(0, 5, 15, 8, 0, 0, Math.PI*2); ctx.fill(); }

        if (this.state === 'WATCHING_FISH') { ctx.fillStyle = '#4db8ff'; ctx.font = '20px Arial'; ctx.fillText("üíô", 0, -45 - (this.frame % 20)); }

        let buttWiggle = (this.type === 'PLAYER' && this.state === 'PLAYING') ? Math.sin(this.frame * 0.8) * 0.15 : 0;
        ctx.rotate(this.angle + Math.PI/2 + buttWiggle);
        let crouch = 1;
        if (this.type === 'PLAYER' && this.state === 'PLAYING') crouch = 0.7; 
        else if (this.state === 'WATCHING_FISH') crouch = 0.8; 
        else if (this.type === 'BITER' && !this.isActing && this.timer < 30) crouch = 0.8 + Math.sin(this.frame)*0.05;
        ctx.scale(1, crouch);

        if (this.swipeAnimTimer > 0) {
            ctx.save(); ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(0, -35, 25, -Math.PI/2 - 0.5, -Math.PI/2 + 0.5); ctx.stroke(); ctx.restore();
        }

        let speedFactor = (this.speed || 0) / 20;
        let walkCycle = this.frame * 0.3 * (this.speed ? this.speed/5 : 0.5);
        if ((this.isPlayer && this.vx === 0 && this.vy === 0) || (isPaused && !this.isPlayer) || this.state === 'WATCHING_FISH') walkCycle = 0;

        let stretch = Math.sin(walkCycle * 2) * 5 * speedFactor;
        let bodyLength = 25 + (this.speed ? this.speed : 0); 

        ctx.strokeStyle = this.colors.b1; ctx.lineWidth = 6; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(0, bodyLength/2);
        let tailSway = (this.speed > 2) ? Math.sin(walkCycle) * 5 : Math.sin(this.frame * 0.05) * 15;
        if (this.type === 'PLAYER' && this.state === 'PLAYING') tailSway = Math.sin(this.frame * 0.5) * 15;
        if (this.type === 'CRAZY' && this.chasingDog) { tailSway = (Math.random()-0.5)*20; ctx.lineWidth = 10; }
        ctx.quadraticCurveTo(tailSway, bodyLength + 10, tailSway * 0.5, bodyLength + 25); ctx.stroke();

        let pawColor = this.colors.b2; let legFL=0, legFR=0, legBL=0, legBR=0;
        if (this.type === 'PLAYER' && this.state === 'PLAYING') { let swipe = Math.sin(this.frame * 0.3); if (swipe > 0) legFL = swipe * 15; else legFR = -swipe * 15; } 
        else if (this.type !== 'BITER') { legFL = Math.sin(walkCycle)*10; legFR = Math.sin(walkCycle + Math.PI)*10; legBL = Math.sin(walkCycle + Math.PI)*12; legBR = Math.sin(walkCycle)*12; }
        if (this.swipeAnimTimer > 0) { legFR = -20; }

        ctx.strokeStyle = pawColor; ctx.lineWidth = 8; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(-8, 15); ctx.lineTo(-10, 20 + legBL); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(8, 15); ctx.lineTo(10, 20 + legBR); ctx.stroke();

        let bodyGrad = ctx.createRadialGradient(-5, -5, 2, 0, 0, 20);
        bodyGrad.addColorStop(0, this.colors.b2); bodyGrad.addColorStop(1, this.colors.b1);
        ctx.fillStyle = bodyGrad; ctx.beginPath(); ctx.ellipse(0, 5, 14 - Math.abs(stretch)/3, bodyLength/2 + stretch, 0, 0, Math.PI*2); ctx.fill();

        if (this.colors.d === 'tuxedo') { ctx.fillStyle = '#222'; ctx.beginPath(); ctx.ellipse(0, 10, 10, 15, 0, 0, Math.PI*2); ctx.fill(); }
        else if (this.colors.d === 'calico') { ctx.fillStyle = '#222'; ctx.beginPath(); ctx.arc(5, 10, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#d2691e'; ctx.beginPath(); ctx.arc(-5, 5, 7, 0, Math.PI*2); ctx.fill(); }

        ctx.strokeStyle = pawColor;
        ctx.beginPath(); ctx.moveTo(-8, -5); ctx.lineTo(-10, -15 - legFL); ctx.stroke(); 
        ctx.beginPath(); ctx.moveTo(8, -5); ctx.lineTo(10, -15 - legFR); ctx.stroke();

        let headShake = (this.type === 'EATER' && this.state === 'HUNTING' && this.targetItem && Math.sqrt((this.targetItem.x-this.x)**2+(this.targetItem.y-this.y)**2)<15) ? Math.sin(this.frame)*3 : 0;
        let headY = -bodyLength/2 + headShake; let earOffset = (this.type === 'PLAYER' && this.state === 'PLAYING') ? 5 : 0; 
        
        ctx.fillStyle = (this.skin==='siamese') ? this.colors.d : this.colors.b1;
        ctx.beginPath(); ctx.moveTo(-12, headY-8+earOffset); ctx.quadraticCurveTo(-20, headY-20+earOffset, -4, headY-14+earOffset);
        ctx.moveTo(12, headY-8+earOffset); ctx.quadraticCurveTo(20, headY-20+earOffset, 4, headY-14+earOffset); ctx.fill();

        let headGrad = ctx.createRadialGradient(0, headY-5, 2, 0, headY, 16);
        headGrad.addColorStop(0, this.colors.b2); headGrad.addColorStop(1, this.colors.b1);
        ctx.fillStyle = headGrad; ctx.beginPath(); ctx.arc(0, headY, 16, 0, Math.PI*2); ctx.fill();

        if (this.colors.d === 'siamese') { ctx.fillStyle = this.colors.d; ctx.beginPath(); ctx.ellipse(0, headY+2, 10, 8, 0, 0, Math.PI*2); ctx.fill(); }
        else if (this.colors.d === 'tabby') { ctx.strokeStyle = '#665'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-5, headY-14); ctx.lineTo(-5, headY-8); ctx.moveTo(0, headY-14); ctx.lineTo(0, headY-8); ctx.moveTo(5, headY-14); ctx.lineTo(5, headY-8); ctx.stroke(); }

        if (!this.isBlinking) {
            ctx.fillStyle = (this.type === 'CRAZY' && (this.chasingDog || this.isPlayer && keys.KeyE)) ? '#ff0000' : this.colors.e; 
            ctx.beginPath(); ctx.arc(-6, headY-4, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(6, headY-4, 3, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.ellipse(-6, headY-4, 1, 2.5, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(6, headY-4, 1, 2.5, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(-7, headY-5, 1, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(5, headY-5, 1, 0, Math.PI*2); ctx.fill();
        } else {
            ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(-9, headY-4); ctx.lineTo(-3, headY-4); ctx.stroke(); ctx.beginPath(); ctx.moveTo(9, headY-4); ctx.lineTo(3, headY-4); ctx.stroke();
        }

        if (this.accessory === 'GLASSES') {
            ctx.fillStyle = 'black'; ctx.fillRect(-10, headY - 8, 8, 5); ctx.fillRect(2, headY - 8, 8, 5);
            ctx.lineWidth = 1; ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(-2, headY-6); ctx.lineTo(2, headY-6); ctx.stroke();
        } else if (this.accessory === 'TOPHAT') {
            ctx.fillStyle = '#111'; ctx.fillRect(-10, headY - 28, 20, 18); ctx.fillRect(-16, headY - 10, 32, 4);
            ctx.fillStyle = 'red'; ctx.fillRect(-10, headY - 14, 20, 4);
        } else if (this.accessory === 'CROWN') {
            ctx.fillStyle = 'gold'; ctx.beginPath(); ctx.moveTo(-10, headY-10); ctx.lineTo(-10, headY-25); 
            ctx.lineTo(-5, headY-15); ctx.lineTo(0, headY-28); ctx.lineTo(5, headY-15); 
            ctx.lineTo(10, headY-25); ctx.lineTo(10, headY-10); ctx.fill();
        } else if (this.accessory === 'BOW') {
            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.moveTo(0, headY+8); ctx.lineTo(-8, headY+4); ctx.lineTo(-8, headY+12); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, headY+8); ctx.lineTo(8, headY+4); ctx.lineTo(8, headY+12); ctx.fill();
        }

        if (this.injuredTimer > 0) {
            ctx.save(); ctx.rotate(0.5);
            ctx.fillStyle = '#f5cba7'; ctx.fillRect(-8, -5, 16, 6);
            ctx.fillStyle = '#e6b0aa'; ctx.beginPath(); ctx.arc(-4, -2, 1, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(4, -2, 1, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }

        ctx.fillStyle = 'pink'; ctx.beginPath(); ctx.arc(0, headY+2, 2.5, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(2, headY+3); ctx.lineTo(18, headY+2); ctx.moveTo(2, headY+4); ctx.lineTo(16, headY+6);
        ctx.moveTo(-2, headY+3); ctx.lineTo(-18, headY+2); ctx.moveTo(-2, headY+4); ctx.lineTo(-16, headY+6); ctx.stroke();

        if (this.type === 'BITER') {
            ctx.rotate(-(this.angle + Math.PI/2)); let p = this.timer/100;
            ctx.strokeStyle = `rgb(255, ${p*255}, 0)`; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0, -35, 10, -Math.PI/2, (Math.PI*2*p)-Math.PI/2); ctx.stroke();
        } else if (this.type === 'EATER' && this.state !== 'LEAVING') {
            ctx.rotate(-(this.angle + Math.PI/2)); ctx.fillStyle = '#4dff88'; ctx.font = "bold 12px sans-serif"; ctx.textAlign="center"; ctx.fillText(this.foodConsumed + "/6", 0, -40);
        }
        ctx.restore();
    }
}

class Item {
    constructor(x, y){
        this.x = x; this.y = y; this.baseX = x; this.baseY = y; this.density = (Math.random() * 30) + 1;
        this.threadAngle = Math.random() * Math.PI; this.eaten = false; this.respawnTimer = 0; 
        let rand = Math.random();
        if (rand < 0.8) { 
            this.type = 'yarn'; this.size = 5;
            let colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff9ff3', '#54a0ff', '#5f27cd'];
            this.color = colors[Math.floor(Math.random() * colors.length)];
        } else { this.type = 'food'; this.size = 3; this.color = '#8B4513'; }
        this.vx = 0; this.vy = 0; this.friction = 0.92; this.returnSpeed = 0.04; 
    }
    draw() {
        if (this.eaten) return; 
        if (this.type === 'yarn') {
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(this.x + 2, this.y + 2, this.size, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.threadAngle); 
            ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(-this.size + 1, 0); ctx.quadraticCurveTo(0, -this.size + 2, this.size - 1, 0);
            ctx.moveTo(0, -this.size + 1); ctx.quadraticCurveTo(this.size - 2, 0, 0, this.size - 1); ctx.stroke();
            ctx.restore();
        } else {
            ctx.fillStyle = this.color; ctx.beginPath();
            ctx.moveTo(this.x, this.y - this.size); ctx.lineTo(this.x + this.size, this.y + this.size); ctx.lineTo(this.x - this.size, this.y + this.size); ctx.fill();
        }
    }
    update() {
        if (this.eaten) { this.respawnTimer--; if (this.respawnTimer <= 0) { this.eaten = false; this.size = (this.type === 'food') ? 3 : 5; } return; }
        let dx = mouse.x - this.x, dy = mouse.y - this.y;
        let d = Math.sqrt(dx*dx + dy*dy);
        if (d < mouse.radius) {
            let force = (mouse.radius - d) / mouse.radius; let angle = Math.atan2(dy, dx);
            this.vx -= Math.cos(angle) * force * 0.5; this.vy -= Math.sin(angle) * force * 0.5;
        }
        catsArray.forEach(cat => {
            if (cat.type === 'BITER' && cat.isActing) {
                let bx = this.x - cat.x, by = this.y - cat.y, dist = Math.sqrt(bx*bx + by*by);
                if (dist < cat.actionRadius && dist > cat.actionRadius - 50) { let a = Math.atan2(by, bx); this.vx += Math.cos(a) * 30; this.vy += Math.sin(a) * 30; }
            } else if (['RUNNER','CRAZY','PLAYER'].includes(cat.type)) {
                 let dist = Math.sqrt((this.x-cat.x)**2 + (this.y-cat.y)**2);
                 if (dist < 30) { let a = Math.atan2(this.y-cat.y, this.x-cat.x); let f = (cat.type==='CRAZY'?5:2); this.vx += Math.cos(a)*f; this.vy += Math.sin(a)*f; }
            }
        });
        dogsArray.forEach(dog => {
            let dist = Math.sqrt((this.x-dog.x)**2 + (this.y-dog.y)**2);
            if (dist < 40) { let a = Math.atan2(this.y-dog.y, this.x-dog.x); this.vx += Math.cos(a)*3; this.vy += Math.sin(a)*3; }
        });
        this.x += this.vx; this.y += this.vy; this.vx *= this.friction; this.vy *= this.friction;
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏
        this.x = Math.max(gameArea.left + 10, Math.min(gameArea.right - 10, this.x));
        this.y = Math.max(gameArea.top + 10, Math.min(gameArea.bottom - 10, this.y));
        if (this.x !== this.baseX) this.x -= (this.x - this.baseX) * this.returnSpeed;
        if (this.y !== this.baseY) this.y -= (this.y - this.baseY) * this.returnSpeed;
    }
}

function adjustColor(color, amount) { return color; }

function init() {
    updateGameArea();
    particleArray = []; 
    aquarium = new Aquarium(gameArea.left + 50, gameArea.bottom - 50);
    let step = 25; 
    for (let y = gameArea.top + 20; y < gameArea.bottom - 20; y += step) { 
        for (let x = gameArea.left + 20; x < gameArea.right - 20; x += step) { 
            particleArray.push(new Item(x, y)); 
        } 
    }
}

function animate() {
    updateGameArea();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // –†–∏—Å—É–µ–º –≥—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.strokeRect(gameArea.left, gameArea.top, gameArea.width, gameArea.height);
    ctx.setLineDash([]);
    
    if (Math.random() < 0.003 && audioContext && audioContext.state === 'running') playSound('meow');
    for(let i=footprints.length-1; i>=0; i--) {
        let fp = footprints[i]; ctx.save(); ctx.translate(fp.x, fp.y); ctx.rotate(fp.angle + Math.PI/2); ctx.fillStyle = `rgba(0,0,0, ${fp.life/300})`; 
        if(fp.type === 'paw') { ctx.beginPath(); ctx.arc(0,0, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-3,-4, 1.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(3,-4, 1.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(0,-5, 1.5, 0, Math.PI*2); ctx.fill(); } 
        else { ctx.beginPath(); ctx.ellipse(0,0, 1, 2, 0, 0, Math.PI*2); ctx.fill(); }
        ctx.restore(); fp.life--; if(fp.life <= 0) footprints.splice(i, 1);
    }
    if (aquarium) aquarium.update();
    let allObjects = [...particleArray, ...miceArray, ...catsArray, ...dogsArray]; if (aquarium) allObjects.push(aquarium);
    allObjects.sort((a, b) => a.y - b.y);
    allObjects.forEach(obj => {
        if (obj instanceof Cat) { obj.draw(); obj.update(); if (obj.markedForDeletion) { catsArray = catsArray.filter(c => c.id !== obj.id); if (playerEntity && playerEntity.id === obj.id) playerEntity = null; } } 
        else if (obj instanceof Dog) { obj.draw(); obj.update(); if (obj.markedForDeletion) { dogsArray = dogsArray.filter(d => d.id !== obj.id); if (playerEntity && playerEntity.id === obj.id) playerEntity = null; } } 
        else if (obj instanceof Mouse) { obj.draw(); obj.update(); if (obj.markedForDeletion) { miceArray = miceArray.filter(m => m.id !== obj.id); } } 
        else if (obj instanceof Aquarium) { obj.draw(); } else { obj.draw(); obj.update(); }
    });
    requestAnimationFrame(animate);
}

init();
animate();
</script>
</body>
</html>